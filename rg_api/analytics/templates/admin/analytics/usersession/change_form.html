{% extends "admin/change_form.html" %} {% block after_field_sets %} {{ block.super }} {% if original.latitude is not None and original.longitude is not None %}
<div style="margin: 20px 0; padding: 10px; background: white; border: 1px solid #ccc">
  <h2>Location Map</h2>
  <!-- Include Leaflet CSS and JS locally in the template to ensure loading order -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <div id="map" style="height: 400px; width: 100%; z-index: 1"></div>

  <script>
    (function () {
      // Ensure L is loaded
      function initMap() {
        if (typeof L === "undefined") {
          console.error("Leaflet not loaded yet, retrying...");
          setTimeout(initMap, 100);
          return;
        }

        var lat = "{{ original.latitude|stringformat:'f' }}";
        var lon = "{{ original.longitude|stringformat:'f' }}";

        // Handle potential comma vs dot decimal separator if locale messes up (though stringformat:f should be safe)
        lat = parseFloat(lat.replace(",", "."));
        lon = parseFloat(lon.replace(",", "."));

        var map = L.map("map").setView([lat, lon], 13);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "Â© OpenStreetMap",
        }).addTo(map);

        L.marker([lat, lon]).addTo(map).bindPopup('{{ original.city|default:"Unknown City"|escapejs }}, {{ original.country|default:"Unknown Country"|escapejs }}').openPopup();
      }

      // Run initialization
      window.addEventListener("load", initMap);
    })();
  </script>
</div>
{% endif %} {% endblock %}
