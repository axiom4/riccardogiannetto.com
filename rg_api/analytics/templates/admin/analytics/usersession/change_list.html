{% extends "admin/change_list.html" %}
{% load static %}

{% block content_title %}
    <h1>Map of User Sessions</h1>
    {{ block.super }}
{% endblock %}

{% block result_list %}
    <div style="margin-bottom: 20px; padding: 10px; background: white; border: 1px solid #ccc;">
        <h2 style="margin-top: 0;">Global Activity Map</h2>
        <div id="sessions_map" style="height: 500px; width: 100%;"></div>
    </div>

    <!-- Leaflet Resources (can be moved to Media if prefered, but here is explicit) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var rawData = '{{ map_locations|escapejs }}';
            var locations = JSON.parse(rawData);

            if (locations.length > 0) {
                 var map = L.map('sessions_map').setView([20, 0], 2);

                 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    attribution: 'Â© OpenStreetMap'
                }).addTo(map);

                // Use a marker cluster group if we had it, but for now simple markers
                // A simple bounds object to fit map to markers
                var bounds = [];

                locations.forEach(function(loc) {
                    if (loc.latitude && loc.longitude) {
                        var marker = L.marker([loc.latitude, loc.longitude]).addTo(map);
                        var popupContent = "<b>" + (loc.city || "Unknown") + ", " + (loc.country || "Unknown") + "</b><br>" + loc.ip_address;
                        marker.bindPopup(popupContent);
                        bounds.push([loc.latitude, loc.longitude]);
                    }
                });

                if (bounds.length > 0) {
                    map.fitBounds(bounds);
                }
            } else {
                document.getElementById('sessions_map').innerHTML = "<p style='padding:20px; text-align:center;'>No geographic data available yet.</p>";
            }
        });
    </script>

    {{ block.super }}
{% endblock %}
