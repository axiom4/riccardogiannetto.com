<div
  class="lightbox"
  [class.is-open]="previewImage()"
  (transitionend)="onLightboxTransitionEnd($event)"
>
  <span class="count"> {{ getIndex() }}/{{ totalImageCount() }} </span>
  @if (previewImage()) {
    <button type="button" (click)="toggleInfo()" class="info-btn" title="Info">
      <span class="icon-lightbox-carousel">Info</span>
    </button>
    <button
      type="button"
      (click)="onclosePreview()"
      class="close-btn"
      title="Close"
    >
      <span
        class="icon-lightbox-carousel"
        onKeyPress=""
        onKeyDown=""
        onKeyUp=""
      >
        Close
      </span>
    </button>
  }
  @if (controls()) {
    <button
      type="button"
      class="btn-lightbox-carousel btn-prev"
      title="Previous"
      (click)="prev()"
    >
      <span class="icon-lightbox-carousel">Prev</span>
    </button>
  }
  @if (controls()) {
    <button
      type="button"
      class="btn-lightbox-carousel btn-next"
      title="Next"
      (click)="next()"
    >
      <span class="icon-lightbox-carousel">Next</span>
    </button>
  }
  <div
    class="lightbox-img"
    [class.is-open]="previewImage()"
    [class.is-loading]="isLoading()"
  >
    <div class="lightbox-frame">
      @if (isLoading()) {
        <div class="loading-msg">
          <div class="loading-box">
            <svg
              width="120"
              height="120"
              viewBox="0 0 64 64"
              xmlns="http://www.w3.org/2000/svg"
            >
              <defs>
                <filter
                  id="shadow"
                  x="-20%"
                  y="-20%"
                  width="140%"
                  height="140%"
                >
                  <feDropShadow
                    dx="2"
                    dy="2"
                    stdDeviation="1"
                    flood-color="rgba(0,0,0,0.5)"
                  />
                </filter>
              </defs>
              <g
                filter="url(#shadow)"
                stroke="#fff"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M8 16 H 18 L 22 10 H 42 L 46 16 H 56 C 58.2 16 60 17.8 60 20 V 48 C 60 50.2 58.2 52 56 52 H 8 C 5.8 52 4 50.2 4 48 V 20 C 4 17.8 5.8 16 8 16 Z"
                  fill="none"
                />
                <circle cx="32" cy="34" r="12" fill="none" />
                <circle cx="32" cy="34" r="9" fill="#fff" stroke="none" />
              </g>
              <text
                x="32"
                y="62"
                font-family="Arial, sans-serif"
                font-size="9"
                text-anchor="middle"
                fill="#fff"
                stroke="none"
                filter="url(#shadow)"
                letter-spacing="1"
              >
                LOADING...
              </text>
            </svg>
          </div>
        </div>
      }
      @if (previousLightboxImg(); as prevImg) {
        @if (prevImg.width && prevImg.height) {
          @for (p of [prevImg]; track p.url) {
            <img
              class="lightbox-image previous"
              [ngClass]="{
                'image-anim-a': imageAnimA(),
                'image-anim-b': !imageAnimA(),
                'page-next': pageFlipDirection() === 'next',
                'page-prev': pageFlipDirection() === 'prev',
              }"
              [alt]="p.title"
              [ngSrc]="getImgId(p)"
              [width]="p.width"
              [height]="p.height"
              sizes="100vw"
              aria-hidden="true"
            />
          }
        }
      }
      @if (currentLightboxImg(); as img) {
        @if (img.width && img.height) {
          @for (i of [img]; track i.url) {
            <img
              #galleryPreviewImg
              class="lightbox-image current"
              [ngClass]="{
                'image-anim-a': !isLoading() && imageAnimA(),
                'image-anim-b': !isLoading() && !imageAnimA(),
                'page-next': pageFlipDirection() === 'next',
                'page-prev': pageFlipDirection() === 'prev',
              }"
              [alt]="i.title"
              [ngSrc]="getImgId(i)"
              [width]="i.width"
              [height]="i.height"
              sizes="100vw"
              priority
              (load)="onImageLoad($event)"
              (error)="onImageLoad($event)"
            />
          }
        }
      }
    </div>
  </div>

  <div
    class="info-panel"
    [class.visible]="showInfo()"
    (click)="$event.stopPropagation()"
    (keydown.enter)="$event.stopPropagation()"
    (mouseleave)="showInfo.set(false)"
    tabindex="0"
  >
    <h2>Image Info</h2>

    @if (hasInfo()) {
      <dl>
        @if (currentLightboxImg()?.camera_model) {
          <div class="info-row">
            <dt>Camera</dt>
            <dd>{{ currentLightboxImg()?.camera_model }}</dd>
          </div>
        }
        @if (currentLightboxImg()?.lens_model) {
          <div class="info-row">
            <dt>Lens</dt>
            <dd>{{ currentLightboxImg()?.lens_model }}</dd>
          </div>
        }
        @if (currentLightboxImg()?.iso_speed) {
          <div class="info-row">
            <dt>ISO</dt>
            <dd>{{ currentLightboxImg()?.iso_speed }}</dd>
          </div>
        }
        @if (currentLightboxImg()?.aperture_f_number) {
          <div class="info-row">
            <dt>Aperture</dt>
            <dd>f/{{ currentLightboxImg()?.aperture_f_number }}</dd>
          </div>
        }
        @if (currentLightboxImg()?.shutter_speed) {
          <div class="info-row">
            <dt>Shutter Speed</dt>
            <dd>
              {{ formatShutterSpeed(currentLightboxImg()?.shutter_speed) }}
            </dd>
          </div>
        }
        @if (currentLightboxImg()?.focal_length) {
          <div class="info-row">
            <dt>Focal Length</dt>
            <dd>{{ currentLightboxImg()?.focal_length }}mm</dd>
          </div>
        }
        @if (currentLightboxImg()?.date) {
          <div class="info-row">
            <dt>Date</dt>
            <dd>{{ currentLightboxImg()?.date | date: "medium" }}</dd>
          </div>
        }
      </dl>

      @if (currentLightboxImg()?.latitude && currentLightboxImg()?.longitude) {
        <div class="map-container">
          <div #mapContainer style="height: 100%; width: 100%"></div>
        </div>
      }
    } @else {
      <div class="no-info">
        <p>No EXIF data available for this photo.</p>
      </div>
    }
  </div>
</div>
<!-- Closing if was removed -->
